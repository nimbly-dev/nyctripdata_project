name: Run Pipeline on PR Comment Command

on:
  issue_comment:
    types: [created]

jobs:
  run_pipeline_on_comment:
    if: github.event.issue.pull_request != null && contains(github.event.comment.body, 'CI:run_yellow_etl_dev')
    runs-on: self-hosted

    steps:
      - name: Check Comment for Command
        id: check_comment
        run: |
          if [[ "${{ github.event.comment.body }}" == "CI:run_yellow_etl_dev" ]]; then
            echo "Triggered by CI:run_yellow_etl_dev comment."
            echo "::set-output name=run_pipeline::true"
          else
            echo "No matching command found in comment."
            echo "::set-output name=run_pipeline::false"
          fi

      - name: Trigger Pipeline via API Request
        if: steps.check_comment.outputs.run_pipeline == 'true'
        id: trigger_pipeline
        env:
          API_URL: "http://magic:6789/api/pipeline_schedules/27/pipeline_runs"
          BEARER_TOKEN: "098b10876caf4d589d61c41752515731"
        run: |
          HTTP_RESPONSE=$(curl -s -o response.json -w "%{http_code}" -X POST "$API_URL" \
            -H "Authorization: Bearer $BEARER_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                  "pipeline_run": {
                    "variables": {
                      "dev_limit_rows": 1000,
                      "pipeline_run_name": "test_workflow_run",
                      "spark_mode": "cluster",
                      "tripdata_type": "yellow_cab_tripdata",
                      "year_month": "2023_1"
                    }
                  }
                }')

          if [ "$HTTP_RESPONSE" -ge 200 ] && [ "$HTTP_RESPONSE" -lt 300 ]; then
            echo "Pipeline triggered successfully."
            PIPELINE_RUN_ID=$(jq -r '.pipeline_run.id' response.json)
            echo "::set-output name=pipeline_run_id::$PIPELINE_RUN_ID"
            echo "status=success" >> $GITHUB_ENV
          else
            echo "Error triggering pipeline. HTTP Status: $HTTP_RESPONSE"
            cat response.json
            echo "status=failure" >> $GITHUB_ENV
            exit 1
          fi

      - name: Check Pipeline Status
        if: steps.check_comment.outputs.run_pipeline == 'true' && steps.trigger_pipeline.outputs.status == 'success'
        id: check_pipeline_status
        env:
          BEARER_TOKEN: "098b10876caf4d589d61c41752515731"
          STATUS_API_URL: "http://magic:6789/api/pipeline_runs/${{ steps.trigger_pipeline.outputs.pipeline_run_id }}"
        run: |
          MAX_ATTEMPTS=30
          ATTEMPT=0
          while [ "$ATTEMPT" -lt "$MAX_ATTEMPTS" ]; do
            STATUS=$(curl -s -H "Authorization: Bearer $BEARER_TOKEN" "$STATUS_API_URL" | jq -r '.pipeline_run.status')
            echo "Pipeline status: $STATUS"
            if [[ "$STATUS" == "completed" ]]; then
              echo "Pipeline completed successfully."
              echo "pipeline_status=COMPLETED" >> $GITHUB_ENV
              break
            elif [[ "$STATUS" == "failed" || "$STATUS" == "error" ]]; then
              echo "Pipeline failed."
              echo "pipeline_status=FAILED" >> $GITHUB_ENV
              break
            elif [[ "$STATUS" == "running" ]]; then
              echo "Pipeline is still running..."
            fi
            ATTEMPT=$((ATTEMPT+1))
            sleep 30
          done
          if [[ "$ATTEMPT" -ge "$MAX_ATTEMPTS" ]]; then
            echo "Pipeline status check timed out."
            echo "pipeline_status=TIMED_OUT" >> $GITHUB_ENV
          fi

      - name: Check Pipeline Status
        if: steps.check_comment.outputs.run_pipeline == 'true' && steps.trigger_pipeline.outputs.status == 'success'
        id: check_pipeline_status
        env:
          BEARER_TOKEN: "098b10876caf4d589d61c41752515731"
          STATUS_API_URL: "http://localhost:6789/api/pipeline_runs/${{ steps.trigger_pipeline.outputs.pipeline_run_id }}"
        run: |
          MAX_ATTEMPTS=100
          ATTEMPT=0
          while [ "$ATTEMPT" -lt "$MAX_ATTEMPTS" ]; do
            # Fetch the pipeline run status
            RESPONSE=$(curl -s -H "Authorization: Bearer $BEARER_TOKEN" "$STATUS_API_URL")
            PIPELINE_STATUS=$(echo "$RESPONSE" | jq -r '.pipeline_run.status')
            BLOCK_STATUSES=$(echo "$RESPONSE" | jq -r '.pipeline_run.block_runs[].status')
            
            echo "Pipeline status: $PIPELINE_STATUS"
            echo "Block statuses: $BLOCK_STATUSES"
            
            # Check if any block is still running
            if echo "$BLOCK_STATUSES" | grep -q "running"; then
              echo "Pipeline is still running..."
            # Check if any block has failed
            elif echo "$BLOCK_STATUSES" | grep -q -E "failed|error"; then
              echo "Pipeline failed."
              echo "pipeline_status=FAILED" >> $GITHUB_ENV
              break
            # Check if all blocks have completed
            elif echo "$BLOCK_STATUSES" | grep -vq "completed"; then
              echo "Pipeline completed successfully."
              echo "pipeline_status=COMPLETED" >> $GITHUB_ENV
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            sleep 30
          done

          if [[ "$ATTEMPT" -ge "$MAX_ATTEMPTS" ]]; then
            echo "Pipeline status check timed out."
            echo "pipeline_status=TIMED_OUT" >> $GITHUB_ENV
          fi
